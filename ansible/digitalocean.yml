- hosts: digitalocean
  vars: 
    do_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30343932646364666239316632376533626637353364333961303439356362623662393537396632
          6564376630363233363336303534316561303464326564350a313639656333393033366638363136
          66393039616337666435313537363062356536336530353134396232336433366230626436346232
          3639343136386336330a666131653934653932623664663839643235666335363062346365613366
          35616134396136653263643438373130653161633835366631353130326234353161373731383935
          33373738393235353262616632333735613937336135393130343333383263393739616630366233
          64386334353831326464316261373263343737363461303966356231663137656463393735353135
          62313737353133393536
    masterdroplet: 
    slavedroplet: 
    es_major_version: "2.x"
    es_version: "2.2.1"
    es_heap_size: "2g"
    es_cluster_name: "production"

  tasks:

  - name: ensure key exists at DigitalOcean
    digital_ocean: >
      state=present
      command=ssh
      name=my_new_key
      ssh_pub_key={{ lookup('file', '../.ssh/id_rsa.pub') }}
      api_token={{ do_token }}
    register: my_ssh_key


  - name: ensure master droplets exist
    digital_ocean: >
      state=present
      command=droplet
      name={{ item }}
      unique_name=yes
      size_id=2gb
      private_networking=yes
      region_id=nyc3
      image_id=ubuntu-16-04-x64
      ssh_key_ids={{ my_ssh_key.ssh_key.id }}
      api_token={{ do_token }}
    with_items: "{{masterdroplet}}"
    register: droplet_details2

  - name: ensure slave droplet exist
    digital_ocean: >
      state=present
      command=droplet
      name={{ item }}
      unique_name=yes
      size_id=2gb
      private_networking=yes
      region_id=nyc3
      image_id=ubuntu-16-04-x64
      ssh_key_ids={{ my_ssh_key.ssh_key.id }}
      api_token={{ do_token }}
    with_items: "{{slavedroplet}}"
    register: droplet_details
